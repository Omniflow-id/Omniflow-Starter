/**
 * Enhanced Activity Logging Usage Examples
 *
 * This file demonstrates how to use the enhanced logging system
 * with request IDs, data change tracking, and sensitive data masking.
 */

const {
  logUserActivity,
  logSystemActivity,
  ACTION_TYPES,
  RESOURCE_TYPES,
  ACTIVITY_STATUS,
} = require("@helpers/log");

// ===== Example 1: User Login with Request Tracking =====
async function logUserLogin(req, user) {
  await logUserActivity({
    activity: "User successfully logged in",
    actionType: ACTION_TYPES.LOGIN,
    resourceType: RESOURCE_TYPES.SESSION,
    resourceId: req.session.id,
    userId: user.id,
    requestInfo: {
      ip: req.ip,
      userAgent: req.get("User-Agent"),
      method: req.method,
      url: req.originalUrl,
    },
    metadata: {
      loginMethod: "password",
      rememberMe: req.body.remember_me || false,
      previousLogin: user.last_login,
    },
    req, // Automatically captures req.requestId
    durationMs: 150,
  });
}

// ===== Example 2: User Data Update with Change Tracking =====
async function logUserUpdate(req, oldUserData, newUserData, adminUser) {
  await logUserActivity({
    activity: `Updated user profile for ${newUserData.username}`,
    actionType: ACTION_TYPES.UPDATE,
    resourceType: RESOURCE_TYPES.USER,
    resourceId: newUserData.id.toString(),
    userId: adminUser.id,
    userInfo: {
      username: adminUser.username,
      email: adminUser.email,
      role: adminUser.role,
    },
    requestInfo: {
      ip: req.ip,
      method: req.method,
      url: req.originalUrl,
    },
    dataChanges: {
      oldData: oldUserData,
      newData: newUserData,
      excludeFields: ["updated_at", "last_modified"], // Exclude timestamps
      maskSensitive: true, // Automatically mask passwords, tokens, etc.
    },
    metadata: {
      updateReason: req.body.update_reason || "admin_action",
      bulkUpdate: false,
    },
    req,
    durationMs: 320,
  });
}

// ===== Example 3: User Creation with Masked Data =====
async function logUserCreation(req, newUserData, adminUser) {
  await logUserActivity({
    activity: "Created new user account",
    actionType: ACTION_TYPES.CREATE,
    resourceType: RESOURCE_TYPES.USER,
    resourceId: newUserData.id.toString(),
    userId: adminUser.id,
    requestInfo: {
      ip: req.ip,
      method: req.method,
      url: req.originalUrl,
    },
    dataChanges: {
      newData: newUserData, // Password will be automatically masked
      maskSensitive: true,
    },
    metadata: {
      creationMethod: "admin_panel",
      sendWelcomeEmail: req.body.send_welcome_email || false,
      autoGeneratedPassword: req.body.auto_password || false,
    },
    req,
    durationMs: 250,
  });
}

// ===== Example 4: Failed Operation with Error Details =====
async function logFailedPasswordUpdate(req, user, error) {
  await logUserActivity({
    activity: "Failed to update user password",
    actionType: ACTION_TYPES.UPDATE,
    resourceType: RESOURCE_TYPES.USER,
    resourceId: user.id.toString(),
    status: ACTIVITY_STATUS.FAILURE,
    userId: user.id,
    requestInfo: {
      ip: req.ip,
      method: req.method,
      url: req.originalUrl,
    },
    errorMessage: error.message,
    errorCode: error.code || "PASSWORD_UPDATE_FAILED",
    metadata: {
      validationErrors: error.validationErrors || [],
      attemptCount: req.session.passwordAttempts || 1,
      securityLevel: "high",
    },
    req,
    durationMs: 25,
  });
}

// ===== Example 5: System Activity (No User Required) =====
async function logSystemMaintenance(operation, results) {
  await logSystemActivity({
    activity: `System maintenance: ${operation} completed`,
    actionType: ACTION_TYPES.SYSTEM_START,
    resourceType: RESOURCE_TYPES.SYSTEM,
    status: results.success ? ACTIVITY_STATUS.SUCCESS : ACTIVITY_STATUS.FAILURE,
    metadata: {
      operation,
      recordsProcessed: results.recordsProcessed,
      duration: results.duration,
      resourcesFreed: results.resourcesFreed,
      nextScheduled: results.nextScheduled,
    },
    req: { requestId: `system_${operation}_${Date.now()}` }, // Custom request ID
    durationMs: results.duration,
  });
}

// ===== Example 6: Cache Operation Logging =====
async function logCacheOperation(operation, pattern, result) {
  await logSystemActivity({
    activity: `Cache ${operation} operation`,
    actionType:
      operation === "flush"
        ? ACTION_TYPES.CACHE_CLEAR
        : ACTION_TYPES.CACHE_INVALIDATE,
    resourceType: RESOURCE_TYPES.CACHE,
    resourceId: pattern,
    status: result.success ? ACTIVITY_STATUS.SUCCESS : ACTIVITY_STATUS.FAILURE,
    metadata: {
      pattern,
      keysAffected: result.keysAffected || 0,
      cacheType: "redis",
      triggerReason: result.reason || "manual",
    },
    durationMs: result.duration,
  });
}

// ===== Express Middleware Example =====
function createLoggingMiddleware() {
  return async (req, res, next) => {
    // Capture start time for duration calculation
    req.startTime = Date.now();

    // Override res.json to log response
    const originalJson = res.json;
    res.json = function (body) {
      const duration = Date.now() - req.startTime;

      // Log API responses (optional)
      if (req.originalUrl.startsWith("/api/")) {
        logSystemActivity({
          activity: `API response: ${req.method} ${req.originalUrl}`,
          actionType: ACTION_TYPES.READ,
          resourceType: RESOURCE_TYPES.SYSTEM,
          status:
            res.statusCode >= 400
              ? ACTIVITY_STATUS.FAILURE
              : ACTIVITY_STATUS.SUCCESS,
          requestInfo: {
            ip: req.ip,
            method: req.method,
            url: req.originalUrl,
          },
          metadata: {
            statusCode: res.statusCode,
            responseSize: JSON.stringify(body).length,
            userAgent: req.get("User-Agent"),
          },
          req,
          durationMs: duration,
        }).catch((err) => console.error("Logging error:", err));
      }

      return originalJson.call(this, body);
    };

    next();
  };
}

module.exports = {
  logUserLogin,
  logUserUpdate,
  logUserCreation,
  logFailedPasswordUpdate,
  logSystemMaintenance,
  logCacheOperation,
  createLoggingMiddleware,
};
