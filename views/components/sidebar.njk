<nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
  <div class="sb-sidenav-menu">
    <div class="nav">
      {# === Core Section === #}
      <div class="sb-sidenav-menu-heading">Core</div>

      {# Dashboard - exact match #}
      <a
        class="nav-link{% if url == '/admin' or url == '/admin/' %} active{% endif %}"
        href="/admin"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
        {{ t('sidebar.dashboard') or 'Dashboard' }}
      </a>

      {# Profile - contains pattern for nested routes #}
      <a
        class="nav-link{% if url.includes('/admin/profile') %} active{% endif %}"
        href="/admin/profile"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-user"></i></div>
        {{ t('sidebar.profile') or 'Profile' }}
      </a>

      {# Module - collapsible parent with prefix match #}
      <a
        class="nav-link{% if url.includes('/admin/overview') or url.includes('/admin/submodule') %} active{% else %} collapsed{% endif %}"
        href="#"
        data-bs-toggle="collapse"
        data-bs-target="#collapseLayouts"
        aria-expanded="{% if url.includes('/admin/overview') or url.includes('/admin/submodule') %}true{% else %}false{% endif %}"
        aria-controls="collapseLayouts"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
        {{ t('sidebar.module') or 'Module' }}
        <div class="sb-sidenav-collapse-arrow">
          <i class="fas fa-angle-down"></i>
        </div>
      </a>
      <div
        class="collapse{% if url.includes('/admin/overview') or url.includes('/admin/submodule') %} show{% endif %}"
        id="collapseLayouts"
        aria-labelledby="headingOne"
        data-bs-parent="#sidenavAccordion"
      >
        <nav class="sb-sidenav-menu-nested nav">
          <a
            class="nav-link{% if url.includes('/admin/overview') %} active{% endif %}"
            href="/admin/overview"
          >{{ t('sidebar.overview') or 'Overview' }}</a>
          <a
            class="nav-link{% if url.includes('/admin/submodule') %} active{% endif %}"
            href="/admin/submodule"
          >{{ t('sidebar.submodule') or 'Sub Module' }}</a>
        </nav>
      </div>

      {# === Administration Section === #}
      {% if hasAnyPermission(permissions, ['view_users', 'manage_users', 'view_permissions', 'manage_permissions', 'view_roles', 'manage_roles']) %}
      <div class="sb-sidenav-menu-heading">Administration</div>
      {% endif %}

      {% if hasAnyPermission(permissions, ['view_users', 'manage_users']) %}
      {# User Management - collapsible parent #}
      <a
        class="nav-link{% if url.includes('/admin/user') %} active{% else %} collapsed{% endif %}"
        href="#"
        data-bs-toggle="collapse"
        data-bs-target="#collapseLayoutsUser"
        aria-expanded="{% if url.includes('/admin/user') %}true{% else %}false{% endif %}"
        aria-controls="collapseLayoutsUser"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>
        {{ t('sidebar.users') or 'Users' }}
        <div class="sb-sidenav-collapse-arrow">
          <i class="fas fa-angle-down"></i>
        </div>
      </a>
      <div
        class="collapse{% if url.includes('/admin/user') %} show{% endif %}"
        id="collapseLayoutsUser"
        aria-labelledby="headingOne"
        data-bs-parent="#sidenavAccordion"
      >
        <nav class="sb-sidenav-menu-nested nav">
          <a
            class="nav-link{% if url.includes('/admin/user/overview') %} active{% endif %}"
            href="/admin/user/overview"
          >{{ t('sidebar.overview') or 'Overview' }}</a>
          <a
            class="nav-link{% if url.includes('/admin/user/index') %} active{% endif %}"
            href="/admin/user/index"
          >{{ t('sidebar.users') or 'Users' }}</a>
        </nav>
      </div>
      {% endif %}

      {% if hasPermission(permissions, 'manage_permissions') %}
      {# Permissions & Roles - collapsible parent #}
      {% set isPermissionsActive = url and (url.includes('/admin/permissions') or url.includes('/admin/roles')) %}
      <a
        class="nav-link{% if isPermissionsActive %} active{% else %} collapsed{% endif %}"
        href="#"
        data-bs-toggle="collapse"
        data-bs-target="#collapseLayoutsPermissions"
        aria-expanded="{% if isPermissionsActive %}true{% else %}false{% endif %}"
        aria-controls="collapseLayoutsPermissions"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-shield-alt"></i></div>
        {{ t('sidebar.permissions') or 'Permissions' }}
        <div class="sb-sidenav-collapse-arrow">
          <i class="fas fa-angle-down"></i>
        </div>
      </a>
      <div
        class="collapse{% if isPermissionsActive %} show{% endif %}"
        id="collapseLayoutsPermissions"
        aria-labelledby="headingOne"
        data-bs-parent="#sidenavAccordion"
      >
        <nav class="sb-sidenav-menu-nested nav">
          <a
            class="nav-link{% if url.includes('/admin/permissions') and not url.includes('/admin/roles') %} active{% endif %}"
            href="/admin/permissions"
          >{{ t('sidebar.allPermissions') or 'All Permissions' }}</a>
          <a
            class="nav-link{% if url.includes('/admin/roles') %} active{% endif %}"
            href="/admin/roles"
          >{{ t('sidebar.roles') or 'Roles' }}</a>
        </nav>
      </div>
      {% endif %}

      {# === System Section === #}
      {% if hasAnyPermission(permissions, ['manage_cache', 'manage_queue', 'view_logs']) %}
      <div class="sb-sidenav-menu-heading">System</div>
      {% endif %}

      {% if hasPermission(permissions, 'manage_cache') %}
      {# Cache Management - direct link #}
      <a
        class="nav-link{% if url.includes('/admin/cache') %} active{% endif %}"
        href="/admin/cache/stats"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-database"></i></div>
        {{ t('sidebar.cache') or 'Cache' }}
      </a>
      {% endif %}

      {% if hasPermission(permissions, 'manage_queue') %}
      {# Queue Management - collapsible parent #}
      <a
        class="nav-link{% if url.includes('/admin/queue') %} active{% else %} collapsed{% endif %}"
        href="#"
        data-bs-toggle="collapse"
        data-bs-target="#collapseLayoutsQueue"
        aria-expanded="{% if url.includes('/admin/queue') %}true{% else %}false{% endif %}"
        aria-controls="collapseLayoutsQueue"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-tasks"></i></div>
        {{ t('sidebar.queue') or 'Queue' }}
        <div class="sb-sidenav-collapse-arrow">
          <i class="fas fa-angle-down"></i>
        </div>
      </a>
      <div
        class="collapse{% if url.includes('/admin/queue') %} show{% endif %}"
        id="collapseLayoutsQueue"
        aria-labelledby="headingOne"
        data-bs-parent="#sidenavAccordion"
      >
        <nav class="sb-sidenav-menu-nested nav">
          <a
            class="nav-link{% if url == '/admin/queue' %} active{% endif %}"
            href="/admin/queue"
          >{{ t('sidebar.statistics') or 'Statistics' }}</a>
          <a
            class="nav-link{% if url.includes('/admin/queue/jobs') %} active{% endif %}"
            href="/admin/queue/jobs"
          >{{ t('sidebar.allJobs') or 'All Jobs' }}</a>
          <a
            class="nav-link{% if url.includes('/admin/queue/failed') %} active{% endif %}"
            href="/admin/queue/failed"
          >{{ t('sidebar.failedJobs') or 'Failed Jobs' }}</a>
        </nav>
      </div>
      {% endif %}

      {% if hasPermission(permissions, 'view_logs') %}
      {# Activity Logs - direct link #}
      <a
        class="nav-link{% if url.includes('/admin/log') %} active{% endif %}"
        href="/admin/log/index"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-file-alt"></i></div>
        {{ t('sidebar.logs') or 'Logs' }}
      </a>
      {% endif %}

{# === AI Management Section #}
      {% if hasAnyPermission(permissions, ['manage_ai_models', 'manage_ai_use_cases', 'use_ai_chat']) %}
      <div class="sb-sidenav-menu-heading">{{ t('sidebar.aiManagement') }}</div>
      {% endif %}

      {% if hasAnyPermission(permissions, ['manage_ai_models', 'manage_ai_use_cases']) %}
      {# AI Configuration - collapsible parent #}
      {% set isAIActive = url and (url.includes('/admin/ai_models') or url.includes('/admin/ai_use_cases')) %}
      <a
        class="nav-link{% if isAIActive %} active{% else %} collapsed{% endif %}"
        href="#"
        data-bs-toggle="collapse"
        data-bs-target="#collapseLayoutsAI"
        aria-expanded="{% if isAIActive %}true{% else %}false{% endif %}"
        aria-controls="collapseLayoutsAI"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-robot"></i></div>
        {{ t('sidebar.aiManagement') }}
        <div class="sb-sidenav-collapse-arrow">
          <i class="fas fa-angle-down"></i>
        </div>
      </a>
      <div
        class="collapse{% if isAIActive %} show{% endif %}"
        id="collapseLayoutsAI"
        aria-labelledby="headingOne"
        data-bs-parent="#sidenavAccordion"
      >
        <nav class="sb-sidenav-menu-nested nav">
          {% if hasPermission(permissions, 'manage_ai_models') %}
          <a
            class="nav-link{% if url.includes('/admin/ai_models') %} active{% endif %}"
            href="/admin/ai_models"
          >{{ t('sidebar.aiModels') }}</a>
          {% endif %}
          {% if hasPermission(permissions, 'manage_ai_use_cases') %}
          <a
            class="nav-link{% if url.includes('/admin/ai_use_cases') %} active{% endif %}"
            href="/admin/ai_use_cases"
          >{{ t('sidebar.aiUseCases') }}</a>
          {% endif %}
        </nav>
      </div>
      {% endif %}

      {% if hasPermission(permissions, 'use_ai_chat') %}
      {# AI Chat - direct link #}
      <a
        class="nav-link{% if url.includes('/admin/chat') %} active{% endif %}"
        href="/admin/chat"
      >
        <div class="sb-nav-link-icon"><i class="fas fa-comments"></i></div>
        {{ t('sidebar.aiChat') }}
      </a>
      {% endif %}
    </div>
  </div>
  <div class="sb-sidenav-footer">
    <div class="small">{{ t('sidebar.loggedInAs') or 'Logged in as' }}:</div>
    <span class="fw-bold">{{ user.username }}</span>
  </div>
</nav>
