{% extends "layout/masterLayout.njk" %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{{ t('ai.analysisSettings.title') }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin">{{ t('sidebar.dashboard') or 'Dashboard' }}</a></li>
        <li class="breadcrumb-item active">{{ t('ai.analysisSettings.breadcrumb') }}</li>
    </ol>

    {% if success_msg and success_msg.length > 0 %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success_msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if error_msg and error_msg.length > 0 %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error_msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-cogs me-1"></i>
            {{ t('ai.analysisSettings.currentConfig') }}
        </div>
        <div class="card-body">
            <div id="loading" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">{{ t('common.loading') or 'Loading...' }}</span>
                </div>
                <p class="mt-2">{{ t('ai.analysisSettings.loading') }}</p>
            </div>

            <div id="error" class="alert alert-danger" style="display: none;">
                <strong>{{ t('common.error') or 'Error!' }}</strong> <span id="error-message"></span>
            </div>

            <div id="settings-content" style="display: none;">
                <!-- Settings details will be loaded here via JavaScript -->
            </div>

            <div id="update-section" style="display: none;" class="mt-4">
                <hr>
                <h5><i class="fas fa-edit me-2"></i>{{ t('ai.analysisSettings.updateSettings') }}</h5>
                <p class="text-muted">{{ t('ai.analysisSettings.updateDescription') }}</p>

                <form id="update-settings-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="selected_model_id" class="form-label">{{ t('ai.analysisSettings.fields.selectedModel') }} <span class="text-danger">*</span></label>
                                <select class="form-select" id="selected_model_id" name="selected_model_id" required>
                                    <option value="">{{ t('common.loading') or 'Loading...' }}</option>
                                </select>
                                <div class="form-text">{{ t('ai.analysisSettings.fields.selectedModel') }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">{{ t('ai.analysisSettings.fields.description') }}</label>
                                <input type="text" class="form-control" id="description" name="description" placeholder="{{ t('ai.analysisSettings.placeholders.description') }}">
                                <div class="form-text">{{ t('ai.analysisSettings.fields.description') }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_tokens" class="form-label">{{ t('ai.analysisSettings.fields.maxTokens') }}</label>
                                <input type="number" class="form-control" id="max_tokens" name="max_tokens" value="4096" min="1" max="32768">
                                <div class="form-text">{{ t('ai.analysisSettings.helpText.maxTokens') }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="temperature" class="form-label">{{ t('ai.analysisSettings.fields.temperature') }}</label>
                                <input type="number" class="form-control" id="temperature" name="temperature" value="0.10" min="0" max="2" step="0.01">
                                <div class="form-text">{{ t('ai.analysisSettings.helpText.temperature') }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>{{ t('ai.analysisSettings.buttons.update') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-info-circle me-1"></i>
            {{ t('ai.analysisSettings.info.title') }}
        </div>
        <div class="card-body">
            <h6>{{ t('ai.analysisSettings.info.aboutTitle') }}</h6>
            <p>{{ t('ai.analysisSettings.info.description') }}</p>
            <ul>
                <li>{{ t('ai.analysisSettings.info.features')[0] }}</li>
                <li>{{ t('ai.analysisSettings.info.features')[1] }}</li>
                <li>{{ t('ai.analysisSettings.info.features')[2] }}</li>
                <li>{{ t('ai.analysisSettings.info.features')[3] }}</li>
            </ul>

            <div class="alert alert-info">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>{{ t('common.tip') or 'Tip:' }}</strong> {{ t('ai.analysisSettings.info.tip') }}
            </div>
        </div>
    </div>
</div>

<script nonce="{{ cspNonce }}">
    const i18n = {
        loading: "{{ t('ai.analysisSettings.loading') }}",
        noSettings: "{{ t('ai.analysisSettings.noSettings') }}",
        currentConfig: "{{ t('ai.analysisSettings.currentConfig') }}",
        params: "{{ t('ai.analysisSettings.fields.params') }}",
        modelName: "{{ t('ai.analysisSettings.fields.modelName') }}",
        modelVariant: "{{ t('ai.analysisSettings.fields.modelVariant') }}",
        apiUrl: "{{ t('ai.analysisSettings.fields.apiUrl') }}",
        maxTokens: "{{ t('ai.analysisSettings.fields.maxTokens') }}",
        temperature: "{{ t('ai.analysisSettings.fields.temperature') }}",
        lastUpdated: "{{ t('ai.analysisSettings.fields.lastUpdated') }}",
        selectModel: "{{ t('ai.analysisSettings.fields.selectModel') }}",
        updated: "{{ t('ai.analysisSettings.messages.updated') }}",
        updateFailed: "{{ t('ai.analysisSettings.messages.error.updateFailed') }}",
        updating: "{{ t('ai.analysisSettings.buttons.updating') }}"
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentSettings();
        loadAvailableModels();
    });

    async function loadCurrentSettings() {
        try {
            const response = await fetch('/admin/ai_analysis_settings/active', {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                displayCurrentSettings(data.data);
                document.getElementById('settings-content').style.display = 'block';
                document.getElementById('update-section').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            } else {
                // No active settings yet
                document.getElementById('settings-content').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${i18n.noSettings}
                    </div>
                `;
                document.getElementById('settings-content').style.display = 'block';
                document.getElementById('update-section').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            showError(error.message);
        }
    }

    async function loadAvailableModels() {
        try {
            const response = await fetch('/admin/ai_models/all', {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.data) {
                const select = document.getElementById('selected_model_id');
                select.innerHTML = `<option value="">${i18n.selectModel}</option>`;

                data.data.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name} (${model.model_variant})`;
                    option.dataset.apiUrl = model.api_url;
                    option.dataset.modelVariant = model.model_variant;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading models:', error);
        }
    }

    function displayCurrentSettings(settings) {
        const container = document.getElementById('settings-content');

        container.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>${i18n.currentConfig}</h6>
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>${i18n.modelName}:</strong></td>
                            <td>${settings.model_name || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>${i18n.modelVariant}:</strong></td>
                            <td><code>${settings.model_variant || 'N/A'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>${i18n.apiUrl}:</strong></td>
                            <td><code>${settings.api_url || 'N/A'}</code></td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>${i18n.params}</h6>
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>${i18n.maxTokens}:</strong></td>
                            <td>${settings.max_tokens}</td>
                        </tr>
                        <tr>
                            <td><strong>${i18n.temperature}:</strong></td>
                            <td>${settings.temperature}</td>
                        </tr>
                        <tr>
                            <td><strong>${i18n.lastUpdated}:</strong></td>
                            <td>${settings.updated_at ? new Date(settings.updated_at).toLocaleString() : 'N/A'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            ${settings.description ? `
            <div class="mt-3">
                <h6>${"{{ t('ai.analysisSettings.fields.description') }}"}</h6>
                <p class="text-muted">${settings.description}</p>
            </div>
            ` : ''}
        `;

        // Set form values
        document.getElementById('selected_model_id').value = settings.selected_model_id || '';
        document.getElementById('description').value = settings.description || '';
        document.getElementById('max_tokens').value = settings.max_tokens || 4096;
        document.getElementById('temperature').value = settings.temperature || 0.10;
    }

    let isUpdating = false;

    document.getElementById('update-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (isUpdating) {
            return;
        }

        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        isUpdating = true;
        submitButton.disabled = true;
        submitButton.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${i18n.updating}`;

        try {
            const formData = {
                selected_model_id: document.getElementById('selected_model_id').value,
                description: document.getElementById('description').value,
                max_tokens: parseInt(document.getElementById('max_tokens').value),
                temperature: parseFloat(document.getElementById('temperature').value)
            };

            const response = await fetch('/admin/ai_analysis_settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf }}'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    ${i18n.updated}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.card'));
                
                // Reload settings
                loadCurrentSettings();
            } else {
                throw new Error(data.message || i18n.updateFailed);
            }
        } catch (error) {
            console.error('Error updating settings:', error);
            showError(error.message);
        } finally {
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
            isUpdating = false;
        }
    });

    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').textContent = message;
        document.getElementById('error').style.display = 'block';
    }
</script>
{% endblock %}
