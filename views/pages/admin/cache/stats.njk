{% extends "layout/masterLayout.njk" %} {% block title %}{{ title }}{% endblock %} {% block content %}
<div class="container-fluid px-4">
  <h1 class="mt-4">{{ title }}</h1>
  <ol class="breadcrumb mb-4">
    <li class="breadcrumb-item"><a href="/admin">{{ nav.dashboard or 'Dashboard' }}</a></li>
    <li class="breadcrumb-item active">{{ pageTitle or 'Cache Management' }}</li>
  </ol>

  <!-- Redis Connection Status -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">
          <i class="fas fa-server me-1"></i>
          {{ stats.connected or 'Redis Connection Status' }}
        </div>
        <div class="card-body">
          {% if redisStats.connected %}
          <div class="d-flex align-items-center mb-3">
            <span class="badge bg-success me-2">
              <i class="fas fa-check-circle me-1"></i>{{ stats.connected or 'Connected' }}
            </span>
          </div>
          <div class="row">
            <div class="col-sm-6">
              <p class="mb-2">
                <strong><i class="fas fa-network-wired me-1"></i>{{ labels.host or 'Host' }}:</strong
                ><br />
                <span class="text-muted"
                  >{{ redisStats.host }}:{{ redisStats.port }}</span
                >
              </p>
            </div>
            <div class="col-sm-6">
              <p class="mb-2">
                <strong><i class="fas fa-database me-1"></i>{{ labels.database or 'Database' }}:</strong
                ><br />
                <span class="text-muted">{{ redisStats.db }}</span>
              </p>
            </div>
          </div>
          <p class="mb-0">
            <strong><i class="fas fa-toggle-on me-1"></i>{{ labels.status or 'Status' }}:</strong><br />
            <span class="text-success">{{ stats.enabled or 'Enabled & Running' }}</span>
          </p>
          {% else %}
          <div class="d-flex align-items-center mb-3">
            <span class="badge bg-danger me-2">
              <i class="fas fa-times-circle me-1"></i>{{ stats.disconnected or 'Disconnected' }}
            </span>
          </div>
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>
            {{ messages.redisUnavailable or 'Redis is not available. Using database fallback.' }}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">
          <i class="fas fa-chart-bar me-1"></i>
          {{ stats.title or 'Cache Statistics' }}
        </div>
        <div class="card-body">
          {% if cacheStats.connected %}
          <div class="row">
            <div class="col-6">
              <div class="text-center">
                <h3 class="text-primary mb-1">
                  {{ cacheStats.database_keys }}
                </h3>
                <p class="text-muted small mb-0">{{ stats.totalKeys or 'Total Keys' }}</p>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <h3 class="text-info mb-1">{{ cacheStats.default_ttl }}s</h3>
                <p class="text-muted small mb-0">{{ labels.defaultTTL or 'Default TTL' }}</p>
              </div>
            </div>
          </div>
          <hr />
          <p class="mb-0">
            <strong><i class="fas fa-key me-1"></i>{{ labels.keyPrefix or 'Key Prefix' }}:</strong><br />
            <code class="bg-light p-1 rounded">{{ cacheStats.prefix }}</code>
          </p>
          {% else %}
          <div class="text-center">
            <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
            <p class="text-muted mb-2">{{ messages.cacheStatsUnavailable or 'Cache statistics unavailable' }}</p>
            {% if cacheStats.error %}
            <small class="text-danger">
              <i class="fas fa-bug me-1"></i>{{ cacheStats.error }}
            </small>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Cache Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-cogs me-1"></i>
          {{ title or 'Cache Management' }}
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3 mb-md-0">
              <div class="card bg-light">
                <div class="card-body text-center p-3">
                  <h6 class="card-title text-danger mb-3">
                    <i class="fas fa-trash-alt me-1"></i>{{ actions.flush or 'Flush All Cache' }}
                  </h6>
                  <form method="post" action="/admin/cache/flush" class="mb-0">
                    {{ csrfField() | safe }}
                    <button
                      type="submit"
                      class="btn btn-danger btn-sm w-100"
                      id="flushCacheBtn"
                    >
                      <i class="fas fa-trash me-1"></i>{{ buttons.flush or 'Flush' }}
                    </button>
                  </form>
                  <small class="text-muted mt-2 d-block"
                    >{{ labels.flushDescription or 'Removes all cached data' }}</small
                  >
                </div>
              </div>
            </div>

            <div class="col-md-8">
              <div class="card bg-light">
                <div class="card-body p-3">
                  <h6 class="card-title text-warning mb-3">
                    <i class="fas fa-search me-1"></i>{{ actions.invalidate or 'Pattern Invalidation' }}
                  </h6>
                  <form
                    method="post"
                    action="/admin/cache/invalidate"
                    id="invalidateForm"
                  >
                    {{ csrfField() | safe }}
                    <div class="input-group mb-2">
                      <span class="input-group-text">
                        <i class="fas fa-key"></i>
                      </span>
                      <input
                        type="text"
                        name="pattern"
                        class="form-control"
                        placeholder="{{ labels.patternPlaceholder or 'admin:users:*, user:*, logs:*' }}"
                        required
                        id="invalidatePattern"
                      />
                      <button
                        type="submit"
                        class="btn btn-warning"
                        id="invalidateBtn"
                      >
                        <i class="fas fa-times-circle me-1"></i>{{ buttons.invalidate or 'Invalidate' }}
                      </button>
                    </div>
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      {{ labels.wildcardInfo or 'Use * for wildcard matching (e.g., admin:* matches all admin keys)' }}
                    </small>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Cache -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-flask me-1"></i>
          {{ test.title or 'Cache Performance Test' }}
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <div class="text-center mb-3 mb-md-0">
                <div class="mb-3">
                  <i class="fas fa-stopwatch text-primary fa-2x mb-2"></i>
                  <h6 class="text-muted">{{ labels.performanceTesting or 'Performance Testing' }}</h6>
                </div>
                <button id="testCacheBtn" class="btn btn-primary">
                  <i class="fas fa-play me-1"></i>{{ test.benchmark or 'Run Benchmark' }}
                </button>
                <p class="text-muted small mt-2 mb-0">
                  {{ labels.testDescription or 'Tests cache read/write performance' }}
                </p>
              </div>
            </div>
            <div class="col-md-8">
              <div id="testResults" class="card bg-light" style="display: none">
                <div class="card-header py-2">
                  <h6 class="mb-0">
                    <i class="fas fa-chart-line me-1"></i>{{ test.result or 'Test Results' }}
                  </h6>
                </div>
                <div class="card-body p-3">
                  <pre
                    id="testOutput"
                    class="mb-0 small"
                    style="max-height: 300px; overflow-y: auto"
                  ></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cache Keys List -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <div>
            <i class="fas fa-key me-1"></i>
            {{ labels.cacheKeys or 'Cache Keys' }}
          </div>
          <div class="d-flex gap-2">
            <div class="input-group" style="width: 200px">
              <input
                type="text"
                id="keyPattern"
                class="form-control form-control-sm"
                placeholder="{{ labels.patternExample or 'Pattern (e.g., user:*)' }}"
                value="*"
              />
              <button id="searchKeys" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-search"></i>
              </button>
            </div>
            <button id="refreshKeys" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-sync-alt me-1"></i>{{ buttons.refresh or 'Refresh' }}
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="keysContainer">
            <div class="text-center py-4">
              <i class="fas fa-key text-muted fa-3x mb-3"></i>
              <p class="text-muted mb-2">{{ messages.keysWillAppear or 'Cache keys will appear here' }}</p>
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                {{ messages.clickRefresh or 'Click refresh to load existing cache keys' }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Modal for Confirmations -->
  <div
    class="modal fade"
    id="confirmModal"
    tabindex="-1"
    aria-labelledby="confirmModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            {{ modals.confirmAction or 'Confirm Action' }}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p id="confirmMessage">{{ modals.confirmMessage or 'Are you sure you want to proceed?' }}</p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            <i class="fas fa-times me-1"></i>{{ buttons.cancel or 'Cancel' }}
          </button>
          <button type="button" class="btn btn-danger" id="confirmActionBtn">
            <i class="fas fa-check me-1"></i>{{ buttons.confirm or 'Confirm' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Real-time Stats -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <div>
            <i class="fas fa-chart-bar me-1"></i>
            {{ labels.realtimeStats or 'Real-time Statistics' }}
          </div>
          <button id="refreshStats" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-sync-alt me-1"></i>{{ buttons.refresh or 'Refresh' }}
          </button>
        </div>
        <div class="card-body">
          <div id="realTimeStats">
            <div class="text-center py-4">
              <i class="fas fa-clock text-muted fa-3x mb-3"></i>
              <p class="text-muted mb-2">{{ messages.realtimeReady or 'Real-time statistics ready' }}</p>
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                {{ messages.clickRefreshStats or 'Click refresh button to load current cache statistics' }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script nonce="{{ cspNonce }}">
  document.addEventListener("DOMContentLoaded", function () {
    const testCacheBtn = document.getElementById("testCacheBtn");
    const testResults = document.getElementById("testResults");
    const testOutput = document.getElementById("testOutput");
    const refreshStats = document.getElementById("refreshStats");
    const realTimeStats = document.getElementById("realTimeStats");
    const refreshKeys = document.getElementById("refreshKeys");
    const searchKeys = document.getElementById("searchKeys");
    const keyPattern = document.getElementById("keyPattern");
    const keysContainer = document.getElementById("keysContainer");

    // Modal elements
    const confirmModal = new bootstrap.Modal(
      document.getElementById("confirmModal")
    );
    const confirmMessage = document.getElementById("confirmMessage");
    const confirmActionBtn = document.getElementById("confirmActionBtn");

    // Simple Toastify functions like in user page
    function showSuccess(message) {
      Toastify({
        text: message,
        duration: 3000,
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        style: {
          background: "linear-gradient(to right, #00b09b, #96c93d)",
          marginTop: "50px",
        },
      }).showToast();
    }

    function showError(message) {
      Toastify({
        text: message,
        duration: 5000,
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        style: {
          background: "linear-gradient(to right, #ff5f6d, #ffc371)",
          marginTop: "50px",
        },
      }).showToast();
    }

    // Simple confirmation function
    function showConfirmModal(message, onConfirm) {
      confirmMessage.innerHTML = message;

      confirmActionBtn.onclick = function () {
        confirmModal.hide();
        onConfirm();
      };

      confirmModal.show();
    }

    // Test cache functionality
    testCacheBtn.addEventListener("click", async function () {
      testCacheBtn.disabled = true;
      testCacheBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Testing...';

      try {
        const response = await fetch("/admin/cache/test", {
          method: "GET",
          credentials: "same-origin",
          headers: {
            Accept: "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        testOutput.textContent = JSON.stringify(data, null, 2);
        testResults.style.display = "block";
        showSuccess("Cache test berhasil!");
      } catch (error) {
        testOutput.textContent = "Error: " + error.message;
        testResults.style.display = "block";
        showError("Cache test failed: " + error.message);
      } finally {
        testCacheBtn.disabled = false;
        testCacheBtn.innerHTML =
          '<i class="fas fa-play me-1"></i>Run Performance Test';
      }
    });

    // Refresh real-time stats
    refreshStats.addEventListener("click", async function () {
      refreshStats.disabled = true;
      refreshStats.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

      try {
        const response = await fetch("/admin/cache/test", {
          method: "GET",
          credentials: "same-origin",
          headers: {
            Accept: "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.cache_info) {
          const cacheInfo = result.cache_info;
          const data = result.data;

          realTimeStats.innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body p-3">
                    <h6 class="card-title text-primary mb-3">
                      <i class="fas fa-server me-1"></i>Cache Performance
                    </h6>
                    <p class="mb-1"><strong><i class="fas fa-tachometer-alt me-1"></i>Source:</strong> ${
                      cacheInfo.source
                    }</p>
                    <p class="mb-1"><strong><i class="fas fa-clock me-1"></i>Response Time:</strong> ${
                      cacheInfo.duration_ms
                    }ms</p>
                    <p class="mb-0"><strong><i class="fas fa-key me-1"></i>Cache Key:</strong> <code class="small">${
                      cacheInfo.key
                    }</code></p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body p-3">
                    <h6 class="card-title text-info mb-3">
                      <i class="fas fa-chart-pie me-1"></i>Test Data
                    </h6>
                    <p class="mb-1"><strong><i class="fas fa-users me-1"></i>Users:</strong> ${
                      data.users
                    }</p>
                    <p class="mb-1"><strong><i class="fas fa-list me-1"></i>Logs:</strong> ${
                      data.logs
                    }</p>
                    <p class="mb-0"><strong><i class="fas fa-sync me-1"></i>Generated:</strong> ${new Date(
                      data.generated_at
                    ).toLocaleString()}</p>
                  </div>
                </div>
              </div>
            </div>
          `;
          showSuccess("Cache statistics berhasil di-refresh!");
        }
      } catch (error) {
        realTimeStats.innerHTML = `
          <div class="alert alert-danger mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <strong>Error loading statistics:</strong> ${error.message}
          </div>
        `;
        showError("Failed to refresh statistics: " + error.message);
      } finally {
        refreshStats.disabled = false;
        refreshStats.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
      }
    });

    // Load cache keys function
    async function loadCacheKeys(pattern = "*", showLoadingAlert = true) {
      try {
        const response = await fetch(
          `/admin/cache/keys?pattern=${encodeURIComponent(pattern)}&limit=50`,
          {
            method: "GET",
            credentials: "same-origin",
            headers: {
              Accept: "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          const data = result.data;

          if (data.keys.length === 0) {
            keysContainer.innerHTML = `
              <div class="text-center py-4">
                <i class="fas fa-search text-muted fa-3x mb-3"></i>
                <p class="text-muted mb-2">No keys found matching pattern: <code>${pattern}</code></p>
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Try a different pattern or create some cache data first
                </small>
              </div>
            `;
          } else {
            let keysHtml = `
              <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Showing ${data.keys.length} of ${data.total} total keys (pattern: <code>${pattern}</code>)
                </small>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th><i class="fas fa-key me-1"></i>Cache Key</th>
                      <th class="text-center"><i class="fas fa-clock me-1"></i>TTL</th>
                      <th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            data.keys.forEach((keyInfo, index) => {
              const ttlDisplay = keyInfo.has_ttl_info
                ? keyInfo.ttl === -1
                  ? '<span class="badge bg-secondary">No TTL</span>'
                  : keyInfo.ttl === -2
                  ? '<span class="badge bg-warning">Expired</span>'
                  : `<span class="badge bg-info">${keyInfo.ttl}s</span>`
                : '<span class="text-muted">-</span>';

              keysHtml += `
                <tr>
                  <td>
                    <code class="small">${keyInfo.short_key}</code>
                  </td>
                  <td class="text-center">
                    ${ttlDisplay}
                  </td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger delete-key-btn" data-key="${keyInfo.key}" title="Delete this key">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              `;
            });

            keysHtml += `
                  </tbody>
                </table>
              </div>
            `;

            keysContainer.innerHTML = keysHtml;
          }
        } else {
          keysContainer.innerHTML = `
            <div class="alert alert-warning mb-0">
              <i class="fas fa-exclamation-triangle me-1"></i>
              <strong>Unable to load keys:</strong> ${
                result.data?.error || "Redis not available"
              }
            </div>
          `;
          showError(
            "Unable to load cache keys: " +
              (result.data?.error || "Redis not available")
          );
        }
      } catch (error) {
        keysContainer.innerHTML = `
          <div class="alert alert-danger mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <strong>Error loading keys:</strong> ${error.message}
          </div>
        `;
        showError("Error loading cache keys: " + error.message);
      }
    }

    // Event delegation for delete key buttons
    keysContainer.addEventListener("click", async function (e) {
      if (e.target.closest(".delete-key-btn")) {
        const button = e.target.closest(".delete-key-btn");
        const key = button.getAttribute("data-key");

        showConfirmModal(
          `<p>Are you sure you want to delete this cache key?</p><p><strong>Key:</strong> <code>${key}</code></p>`,
          async function () {
            // Disable button during deletion
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
              // Remove prefix to get the exact key pattern - use hardcoded prefix
              const prefix = "omniflow:";
              const pattern = key.startsWith(prefix)
                ? key.substring(prefix.length)
                : key;

              // Get CSRF token from existing form on the page
              const csrfInput = document.querySelector('input[name="_csrf"]');
              const csrfToken = csrfInput ? csrfInput.value : "";

              if (!csrfToken) {
                showError("CSRF token not found. Please refresh the page.");
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-trash-alt"></i>';
                return;
              }

              const response = await fetch("/admin/cache/invalidate", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                  "X-Requested-With": "XMLHttpRequest",
                },
                body: `pattern=${encodeURIComponent(
                  pattern
                )}&_csrf=${encodeURIComponent(csrfToken)}`,
              });

              if (response.ok) {
                const result = await response.json();

                if (result.success) {
                  showSuccess("Cache key berhasil dihapus!");
                  loadCacheKeys(keyPattern.value, false);
                } else {
                  showError(
                    "Failed to delete key: " + (result.error || "Unknown error")
                  );
                }
              } else {
                showError(
                  `Failed to delete key (${response.status}): ${response.statusText}`
                );
              }
            } catch (error) {
              showError("Error deleting key: " + error.message);
            } finally {
              // Re-enable button
              button.disabled = false;
              button.innerHTML = '<i class="fas fa-trash-alt"></i>';
            }
          }
        );
      }
    });

    // Search keys event listeners
    refreshKeys.addEventListener("click", function () {
      loadCacheKeys(keyPattern.value);
    });

    searchKeys.addEventListener("click", function () {
      loadCacheKeys(keyPattern.value);
    });

    keyPattern.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        loadCacheKeys(keyPattern.value);
      }
    });

    // Flush cache confirmation with modal
    const flushCacheBtn = document.getElementById("flushCacheBtn");
    if (flushCacheBtn) {
      flushCacheBtn.addEventListener("click", function (e) {
        e.preventDefault();

        showConfirmModal(
          "<p><strong>Warning:</strong> This will permanently delete all cached data!</p><p>Are you sure you want to flush the entire cache?</p>",
          async function () {
            const form = flushCacheBtn.closest("form");

            try {
              // Get CSRF token from form
              const csrfInput = form.querySelector('input[name="_csrf"]');
              const csrfToken = csrfInput ? csrfInput.value : "";

              if (!csrfToken) {
                showError("CSRF token not found. Please refresh the page.");
                return;
              }

              // Submit form using fetch to handle response properly
              const response = await fetch(form.action, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                  "X-Requested-With": "XMLHttpRequest",
                },
                body: `_csrf=${encodeURIComponent(csrfToken)}`,
              });

              if (response.ok) {
                const result = await response.json();
                if (result.success) {
                  showSuccess("Cache berhasil di-flush!");
                  // Refresh the page to see updated stats
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  showError(
                    "Gagal flush cache: " + (result.error || "Unknown error")
                  );
                }
              } else {
                // For non-AJAX responses, assume success and show message
                showSuccess("Cache berhasil di-flush!");
                setTimeout(() => window.location.reload(), 1000);
              }
            } catch (error) {
              // Fallback to regular form submission
              showSuccess("Cache berhasil di-flush!");
              form.submit();
            }
          }
        );
      });
    }

    // Handle pattern invalidation form
    const invalidateForm = document.getElementById("invalidateForm");
    const invalidateBtn = document.getElementById("invalidateBtn");
    const invalidatePattern = document.getElementById("invalidatePattern");

    if (invalidateForm) {
      invalidateForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const pattern = invalidatePattern.value.trim();
        if (!pattern) {
          showError("Please enter a pattern to invalidate");
          return;
        }

        showConfirmModal(
          `<p>Are you sure you want to invalidate cache keys matching this pattern?</p><p><strong>Pattern:</strong> <code>${pattern}</code></p>`,
          async function () {
            const originalText = invalidateBtn.innerHTML;
            invalidateBtn.disabled = true;
            invalidateBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin me-1"></i>Invalidating...';

            try {
              // Get CSRF token from form
              const csrfInput = invalidateForm.querySelector(
                'input[name="_csrf"]'
              );
              const csrfToken = csrfInput ? csrfInput.value : "";

              if (!csrfToken) {
                showError("CSRF token not found. Please refresh the page.");
                invalidateBtn.disabled = false;
                invalidateBtn.innerHTML = originalText;
                return;
              }

              const response = await fetch(invalidateForm.action, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                  "X-Requested-With": "XMLHttpRequest",
                },
                body: `pattern=${encodeURIComponent(
                  pattern
                )}&_csrf=${encodeURIComponent(csrfToken)}`,
              });

              if (response.ok) {
                const result = await response.json();
                if (result.success) {
                  showSuccess(
                    `Cache pattern berhasil di-invalidate! (${
                      result.data.deleted_count || 0
                    } keys deleted)`
                  );
                  invalidatePattern.value = "";
                  // Refresh the cache keys list
                  loadCacheKeys(keyPattern.value, false);
                } else {
                  showError(
                    "Gagal invalidate cache: " +
                      (result.error || "Unknown error")
                  );
                }
              } else {
                // For non-AJAX responses, assume success
                showSuccess("Cache pattern berhasil di-invalidate!");
                invalidatePattern.value = "";
                loadCacheKeys(keyPattern.value, false);
              }
            } catch (error) {
              showError("Error invalidating cache: " + error.message);
            } finally {
              invalidateBtn.disabled = false;
              invalidateBtn.innerHTML = originalText;
            }
          }
        );
      });
    }

    // Auto-load keys on page load (silently, without alerts)
    loadCacheKeys("*", false);
  });
</script>
{% endblock %}
