{% extends "layout/masterLayout.njk" %}
{% block title %}{{ t('pageTitle') }}{% endblock %}
{% block content %}
<div class="container-fluid px-4">
  <h1 class="mt-4">{{ t('pageTitle') }}</h1>
  <ol class="breadcrumb mb-4">
    <li class="breadcrumb-item"><a href="/admin">{{ t('sidebar.dashboard') }}</a></li>
    <li class="breadcrumb-item active">{{ t('pageTitle') }}</li>
  </ol>

  <!-- Add Permission Button -->
  <div class="mb-4">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#permissionModal">
      <i class="fas fa-plus me-1"></i> {{ t('createNewPermission') }}
    </button>
  </div>

  <!-- Permissions List -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-key me-1"></i>
      {{ t('allSystemPermissions') }}
    </div>
    <div class="card-body">
      <div class="row">
        {% for permission in allPermissions %}
        <div class="col-md-6 col-lg-4 mb-3">
          <div class="card border-left-primary h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="small text-gray-500">{{ t('permission') }}</div>
                  <div class="font-weight-bold text-primary">
                    {{ permission.permission_name }}
                  </div>
                  <div class="text-xs text-gray-600 mt-1">
                    {{ permission.description }}
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-light me-2" data-bs-toggle="modal" data-bs-target="#permissionModal" data-permission-id="{{ permission.permission_id }}" data-permission-name="{{ permission.permission_name }}" data-permission-description="{{ permission.description }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <form action="/admin/permissions/{{ permission.permission_id }}/delete" method="POST" class="d-inline" onsubmit="return confirm('{{ t('messages.confirmDelete') }}');">
                    {{ csrfField() | safe }}
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if allPermissions.length == 0 %}
      <div class="text-center py-4">
        <i class="fas fa-key fa-3x text-gray-300 mb-3"></i>
        <p class="text-gray-500">{{ t('noPermissionsFound') }}</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Permission Modal -->
<div class="modal fade" id="permissionModal" tabindex="-1" aria-labelledby="permissionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="permissionModalLabel">{{ t('createNewPermission') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="permissionForm" action="/admin/permissions" method="POST">
        {{ csrfField() | safe }}
        <div class="modal-body">
          <div class="mb-3">
            <label for="permission_name" class="form-label">{{ t('form.name') }}</label>
            <input type="text" class="form-control" id="permission_name" name="permission_name" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">{{ t('form.description') }}</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('buttons.close') }}</button>
          <button type="submit" class="btn btn-primary">{{ t('savePermission') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Quick Stats -->
  <div class="row">
    <div class="col-xl-3 col-md-6">
      <div class="card bg-primary text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="small">{{ t('stats.total') }}</div>
              <div class="font-weight-bold">{{ allPermissions.length }}</div>
            </div>
            <div>
              <i class="fas fa-key fa-2x"></i>
            </div>
          </div>
        </div>
        <div
          class="card-footer d-flex align-items-center justify-content-between"
        >
          <a
            class="small text-white stretched-link"
            href="/admin/roles"
          >
            {{ t('stats.manageRolePermissions') }}
          </a>
          <div class="small text-white">
            <i class="fas fa-angle-right"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card bg-success text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="small">{{ t('stats.systemPermissions') }}</div>
              <div class="font-weight-bold">
                {{ allPermissions | selectattr("permission_name", "match", "^manage_") | list | length }}
              </div>
            </div>
            <div>
              <i class="fas fa-cogs fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card bg-info text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="small">{{ t('stats.viewPermissions') }}</div>
              <div class="font-weight-bold">
                {{ allPermissions | selectattr("permission_name", "match", "^view_") | list | length }}
              </div>
            </div>
            <div>
              <i class="fas fa-eye fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card bg-warning text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="small">{{ t('stats.actionPermissions') }}</div>
              <div class="font-weight-bold">
                {{ allPermissions | selectattr("permission_name", "match", "^approve_") | list | length }}
              </div>
            </div>
            <div>
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const permissionModal = document.getElementById('permissionModal');
    permissionModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const permissionId = button.getAttribute('data-permission-id');
      const form = document.getElementById('permissionForm');
      const modalTitle = permissionModal.querySelector('.modal-title');

      if (permissionId) {
        modalTitle.textContent = '{{ t('editPermission') }}';
        form.action = `/admin/permissions/${permissionId}/update`;
        document.getElementById('permission_name').value = button.getAttribute('data-permission-name');
        document.getElementById('description').value = button.getAttribute('data-permission-description');
      } else {
        modalTitle.textContent = '{{ t('createNewPermission') }}';
        form.action = '/admin/permissions';
        form.reset();
      }
    });
  });
</script>
{% endblock %}
