{% extends "layout/masterLayout.njk" %} {% block content %}
<div class="container-fluid px-4">
  <h1 class="mt-4">{{ pageTitle or 'User Management' }}</h1>


  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header">
          <div
            class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2"
          >
            <span class="mb-2 mb-sm-0">{{ userList or 'User List' }}</span>
            <div class="d-flex flex-wrap gap-2">
              <button
                class="btn btn-info btn-sm text-white"
                id="btnDownloadData"
              >
                <i class="fas fa-file-excel me-1"></i>
                <span class="d-none d-sm-inline">{{ downloadData or 'Download Data' }}</span>
                <span class="d-inline d-sm-none">Data</span>
              </button>
              <button
                class="btn btn-secondary btn-sm text-white"
                id="btnUpload"
                data-bs-toggle="modal"
                data-bs-target="#uploadModal"
              >
                <i class="fas fa-upload me-1"></i>
                <span class="d-none d-sm-inline">{{ uploadDataUser or 'Upload Data User' }}</span>
                <span class="d-inline d-sm-none">Upload</span>
              </button>
              <button class="btn btn-success btn-sm" id="btnDownloadTemplate">
                <i class="fas fa-download me-1"></i>
                <span class="d-none d-sm-inline">{{ downloadTemplate or 'Download Template' }}</span>
                <span class="d-inline d-sm-none">Template</span>
              </button>
              <button
                class="btn btn-primary btn-sm"
                id="btnTambah"
                data-bs-toggle="modal"
                data-bs-target="#tambahModal"
              >
                <i class="fas fa-plus me-1"></i>
                <span class="d-none d-sm-inline">{{ tambahUser or 'Add User' }}</span>
                <span class="d-inline d-sm-none">{{ tambah or 'Add' }}</span>
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <table
            id="datatablesSimple"
            class="table table-striped"
            style="width: 100%"
          >
            <thead>
              <tr>
                <th>{{ table.id or 'ID' }}</th>
                <th>{{ table.name or 'Name' }}</th>
                <th>{{ table.email or 'Email' }}</th>
                <th>{{ table.role or 'Role' }}</th>
                <th>{{ table.status or 'Status' }}</th>
                <th>{{ table.actions or 'Actions' }}</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Upload -->
<div
  class="modal fade"
  id="uploadModal"
  tabindex="-1"
  aria-labelledby="uploadModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">{{ modals.importUsers or 'Import Users' }}</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form
        id="uploadForm"
        enctype="multipart/form-data"
        method="post"
        action="/admin/user/upload"
      >
        <div class="modal-body">
          {{ csrfField() | safe }}
          <div class="mb-3">
            <label for="fileUpload" class="form-label"
              >{{ form.chooseFile or 'Choose file to upload:' }}</label
            >
            <input
              type="file"
              class="form-control"
              id="fileUpload"
              name="fileUpload"
              accept=".xls,.xlsx"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            {{ buttons.cancel or 'Cancel' }}
          </button>
          <button type="submit" class="btn btn-primary" form="uploadForm">
            Upload
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for Tambah User -->
<div
  class="modal fade"
  id="tambahModal"
  tabindex="-1"
  aria-labelledby="tambahModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tambahModalLabel">{{ modals.createUser or 'Create User' }}</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form id="tambahForm" method="POST" action="/admin/user/create">
        <div class="modal-body">
          {{ csrfField() | safe }}
          <div class="mb-3">
            <label for="username" class="form-label">{{ form.username or 'Username' }}:</label>
            <input
              type="text"
              class="form-control"
              id="username"
              name="username"
              required
            />
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">{{ form.email or 'Email' }}:</label>
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              required
            />
          </div>
          <div class="mb-3">
            <label for="full_name" class="form-label">{{ form.name or 'Full Name' }}:</label>
            <input
              type="text"
              class="form-control"
              id="full_name"
              name="full_name"
              placeholder="Contoh: John Smith"
              required
            />
            <div class="form-text">
              {{ messages.passwordGenerated or 'Password will be auto-generated' }}: FullName@12345?.
            </div>
          </div>
          <div class="mb-3">
            <label for="role" class="form-label">{{ form.role or 'Role' }}:</label>
            <select class="form-control" id="role" name="role_id" required>
              <option value="">{{ form.selectRole or 'Select Role' }}</option>
              {% for role in roles %}
              <option value="{{ role.role_id }}">{{ role.role_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            {{ buttons.cancel or 'Cancel' }}
          </button>
          <button type="submit" class="btn btn-primary" form="tambahForm">
            {{ buttons.save or 'Save' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById("btnDownloadData").addEventListener("click", () => {
    window.location.href = "/admin/user/download";
    Toastify({
      text: "{{ messages.downloadSuccess or 'Download successful!' }}",
      duration: 5000,
      close: true,
      gravity: "top",
      position: "right",
      stopOnFocus: true,
      style: {
        background: "linear-gradient(to right, #00b09b, #96c93d)",
        marginTop: "50px",
      },
      onClick: function () {},
    }).showToast();
  });
</script>

{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    $("#datatablesSimple").DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '/api/datatable/users',
        type: 'GET'
      },
      columns: [
        { data: 0, name: 'id' },
        { data: 1, name: 'username' },
        { data: 2, name: 'email' },
        { data: 3, name: 'role' },
        {
          data: 4,
          name: 'is_active',
          orderable: false
        },
        {
          data: 5,
          name: 'actions',
          orderable: false,
          searchable: false
        }
      ],
      order: [[0, 'desc']],
      pageLength: 25,
      responsive: true,
      language: {
        search: "{{ datatable.search or 'Search users:' }}",
        lengthMenu: "{{ datatable.lengthMenu or 'Show _MENU_ users per page' }}",
        info: "{{ datatable.info or 'Showing _START_ to _END_ of _TOTAL_ users' }}",
        infoEmpty: "{{ datatable.infoEmpty or 'No users found' }}",
        infoFiltered: "{{ datatable.infoFiltered or '(filtered from _MAX_ total users)' }}",
        processing: "{{ datatable.processing or 'Processing...' }}",
        loadingRecords: "{{ datatable.loadingRecords or 'Loading...' }}",
        zeroRecords: "{{ datatable.zeroRecords or 'No matching records found' }}"
      }
    });
  });

  $("#btnDownloadTemplate").on("click", function () {
    window.location.href = "/admin/user/download-template";
    Toastify({
      text: "{{ messages.downloadSuccess or 'Download successful!' }}",
      duration: 5000,
      close: true,
      gravity: "top",
      position: "right",
      stopOnFocus: true,
      style: {
        background: "linear-gradient(to right, #00b09b, #96c93d)",
        marginTop: "50px",
      },
      onClick: function () {},
    }).showToast();
  });

  // Handle Delete User
  $(document).on('click', '.btn-delete-user', function() {
    const userId = $(this).data('id');
    const username = $(this).data('username');

    if (confirm("{{ messages.confirmDelete or 'Are you sure you want to delete this user?' }}")) {
      $.ajax({
        url: `/admin/user/delete/${userId}`,
        type: 'POST',
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content') || ""
        },
        success: function(response) {
          if (response.success) {
            Toastify({
              text: response.message,
              duration: 3000,
              style: {
                background: "linear-gradient(to right, #00b09b, #96c93d)",
                marginTop: "50px",
              },
            }).showToast();
            $('#datatablesSimple').DataTable().ajax.reload();
          } else {
            alert(response.message);
          }
        },
        error: function(xhr) {
          const response = xhr.responseJSON;
          alert(response ? response.message : "{{ messages.error or 'An error occurred' }}");
        }
      });
    }
  });
</script>
{% endblock %}
