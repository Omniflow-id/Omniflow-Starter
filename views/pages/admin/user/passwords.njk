{% extends "layout/masterLayout.njk" %}

{% block title %}Generated Passwords{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">üìã Generated Passwords</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/user/index">Users</a></li>
        <li class="breadcrumb-item active">Generated Passwords</li>
    </ol>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <a href="/admin/user/index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Users
                </a>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success" id="copyAllBtn">
                        <i class="fas fa-copy"></i> Copy All Passwords
                    </button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print This Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Important Notice -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Important Security Notice</h5>
                <ul class="mb-0">
                    <li>These passwords are <strong>generated automatically</strong> using the pattern: <code>FullName@12345?.</code></li>
                    <li>Please <strong>copy or print this information immediately</strong> - it will not be shown again</li>
                    <li>Inform users that they should <strong>change their password</strong> after first login</li>
                    <li>Consider setting up email notifications for password reset reminders</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Password List Card -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-key"></i> Generated User Passwords 
                        <span class="badge bg-primary">{{ generatedPasswords | length }} users</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Password Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="passwordTable">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Username</th>
                                    <th scope="col">Full Name</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Role</th>
                                    <th scope="col">Generated Password</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in generatedPasswords %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <span class="fw-bold">{{ user.username }}</span>
                                    </td>
                                    <td>{{ user.full_name }}</td>
                                    <td>
                                        <code>{{ user.email }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if user.role == 'Admin' %}danger{% elif user.role == 'Manager' %}warning{% else %}info{% endif %}">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <code class="password-text me-2" id="password-{{ loop.index }}">{{ user.generatedPassword }}</code>
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary copy-btn" 
                                                data-password="{{ user.generatedPassword }}"
                                                data-username="{{ user.username }}">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Format for Communication -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-clipboard-list"></i> Copy-Paste Format for Communication</h6>
                </div>
                <div class="card-body">
                    <div class="bg-light p-3 rounded">
                        <pre id="communicationFormat" class="mb-0">{% for user in generatedPasswords %}{{ user.full_name }} ({{ user.email }}): {{ user.generatedPassword }}
{% endfor %}</pre>
                    </div>
                    <button type="button" class="btn btn-secondary mt-2" id="copyFormatBtn">
                        <i class="fas fa-copy"></i> Copy Communication Format
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">üìä Password Statistics</h6>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Total Users:</strong> {{ generatedPasswords | length }}</li>
                        <li><strong>Pattern:</strong> FullName@12345?.</li>
                        <li><strong>Average Length:</strong> 
                            {% set totalLength = 0 %}
                            {% for user in generatedPasswords %}
                                {% set totalLength = totalLength + user.generatedPassword | length %}
                            {% endfor %}
                            {{ (totalLength / generatedPasswords | length) | round(1) }} characters
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">üîê Security Notes</h6>
                    <ul class="list-unstyled mb-0">
                        <li>‚úÖ All passwords are hashed in database</li>
                        <li>‚úÖ Meet complexity requirements (8+ chars, symbols, numbers)</li>
                        <li>‚ö†Ô∏è Users should change password after first login</li>
                        <li>üìß Consider sending reset password emails</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Pattern Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Password Pattern Explanation</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">The password pattern is predictable for easy communication to users:</p>
                    <div class="bg-light p-3 rounded mb-3">
                        <code>FullNameWithoutSpaces@12345?.</code>
                    </div>
                    <p class="mb-0">
                        <strong>Examples:</strong><br>
                        ‚Ä¢ John Smith ‚Üí <code>JohnSmith@12345?.</code><br>
                        ‚Ä¢ Maria Santos Silva ‚Üí <code>MariaSantosSilva@12345?.</code><br>
                        ‚Ä¢ Ais ‚Üí <code>Ais@12345?.</code>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Copy Functionality and DataTables -->
<script nonce="{{ cspNonce }}">
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTables
    $('#passwordTable').DataTable({
        responsive: true,
        order: [[0, 'asc']],
        pageLength: 25,
        columnDefs: [
            { 
                targets: [6], 
                orderable: false,
                searchable: false
            },
            { className: "text-center", targets: [0, 6] }
        ],
        language: {
            search: "Search users:",
            lengthMenu: "Show _MENU_ users per page",
            info: "Showing _START_ to _END_ of _TOTAL_ users",
            infoEmpty: "No users found",
            infoFiltered: "(filtered from _MAX_ total users)"
        }
    });
    // Individual copy buttons
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const password = this.dataset.password;
            const username = this.dataset.username;
            
            navigator.clipboard.writeText(password).then(() => {
                // Show success feedback
                const originalIcon = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check text-success"></i>';
                this.classList.add('btn-success');
                this.classList.remove('btn-outline-primary');
                
                setTimeout(() => {
                    this.innerHTML = originalIcon;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-primary');
                }, 2000);
                
                // Show toast notification
                showToast(`Password copied for ${username}`, 'success');
            }).catch(() => {
                showToast('Failed to copy password', 'error');
            });
        });
    });
    
    // Copy all passwords button
    document.getElementById('copyAllBtn').addEventListener('click', function() {
        const passwords = [];
        {% for user in generatedPasswords %}
        passwords.push('{{ user.full_name }} ({{ user.email }}): {{ user.generatedPassword }}');
        {% endfor %}
        
        const allPasswords = passwords.join('\n');
        
        navigator.clipboard.writeText(allPasswords).then(() => {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i> Copied All!';
            this.classList.add('btn-success');
            this.classList.remove('btn-primary');
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('btn-success');
                this.classList.add('btn-primary');
            }, 3000);
            
            showToast('All passwords copied to clipboard', 'success');
        }).catch(() => {
            showToast('Failed to copy passwords', 'error');
        });
    });
    
    // Copy communication format button
    document.getElementById('copyFormatBtn').addEventListener('click', function() {
        const formatText = document.getElementById('communicationFormat').textContent;
        
        navigator.clipboard.writeText(formatText).then(() => {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i> Copied!';
            this.classList.add('btn-success');
            this.classList.remove('btn-secondary');
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('btn-success');
                this.classList.add('btn-secondary');
            }, 2000);
            
            showToast('Communication format copied', 'success');
        }).catch(() => {
            showToast('Failed to copy format', 'error');
        });
    });
});

// Toast notification function using Toastify (matching project standard)
function showToast(message, type = 'info') {
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = "linear-gradient(to right, #00b09b, #96c93d)";
            break;
        case 'error':
            backgroundColor = "linear-gradient(to right, #ff5f6d, #ffc371)";
            break;
        default:
            backgroundColor = "linear-gradient(to right, #667eea, #764ba2)";
    }
    
    Toastify({
        text: message,
        duration: 5000,
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        style: {
            background: backgroundColor,
            marginTop: "50px",
        },
        onClick: function () {},
    }).showToast();
}
</script>

<!-- Print Styles -->
<style>
@media print {
    .btn, .alert, .card-header {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .table {
        font-size: 12px;
    }
    
    .password-text {
        font-weight: bold;
        background: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
    }
}
</style>
{% endblock %}